name: Generate SBOM

on:
  workflow_dispatch:
  release:
    types: [created]

jobs:
  sbom:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    steps:
      # 1️⃣ 取得程式碼
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ 設定 Node.js 版本
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ✅ Cache node_modules
      - name: Cache node_modules
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # ✅ Install deps
      - name: Install dependencies
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm ci

      # 4️⃣ 產生 SBOM（Anchore Syft）
      - name: Anchore SBOM Action
        uses: anchore/sbom-action@v0.20.9
        with:
          path: .                          # 掃描整個 repo
          format: spdx-json                # 輸出 SPDX JSON 格式
          artifact-name: desktop-server-sbom-spdx
          upload-artifact: true
          upload-release-assets: false

      # （可選）5️⃣ 檢查輸出
      - name: Verify generated SBOM
        run: ls -lh *.spdx.json || true
