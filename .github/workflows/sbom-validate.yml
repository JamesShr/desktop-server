name: Validate SBOM (CycloneDX)

on:
  workflow_run:
    workflows: ["Generate SBOM"]
    types:
      - completed

jobs:
  validate:
    runs-on: ubuntu-latest

    permissions:
      actions: read        # ✅ 需要 actions:read 才能讀取前一個 run 的 artifact
      contents: read

    steps:
      - name: Download SBOM artifact from previous workflow
        uses: actions/download-artifact@v4
        with:
          name: desktop-server-sbom-spdx
          path: ./sbom
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}

      - name: Install SPDX Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre
          # 找出最新 release 的 jar
          LATEST_URL=$(curl -s https://api.github.com/repos/spdx/tools/releases/latest \
            | grep browser_download_url \
            | grep 'jar-with-dependencies.jar' \
            | cut -d '"' -f 4)
          echo "Downloading SPDX Tools from: $LATEST_URL"
          wget -O spdx-tools.jar "$LATEST_URL"
      
      - name: Validate SPDX SBOM
        run: |
          java -jar spdx-tools.jar Verify ./sbom/desktop-server.spdx.json

