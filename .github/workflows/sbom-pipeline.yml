name: SBOM Full Pipeline (Generate â†’ Validate â†’ Scan â†’ Diff)

on:
  release:
    types: [created]

jobs:
  # ------------------------------------------------------
  # â‘  Generate SBOM
  # ------------------------------------------------------
  generate:
    name: Generate SBOM
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      # 1ï¸âƒ£ å–å¾—ç¨‹å¼ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ å–å¾— release tag åç¨±
      - name: Get release tag
        id: tag
        run: echo "tag_name=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT

      # 3ï¸âƒ£ å®‰è£ Node.js ä¸¦å¿«å–ä¾è³´
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node_modules
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm ci

      # 4ï¸âƒ£ ç”¢ç”Ÿ SBOMï¼ˆAnchore Syftï¼‰
      - name: Anchore SBOM Action
        uses: anchore/sbom-action@v0.20.9
        with:
          path: .
          format: cyclonedx-json
          upload-artifact: false
          upload-release-assets: false
          output-file: desktop-server.cyclonedx.json

      # 5ï¸âƒ£ ä¸Šå‚³ SBOM åˆ° Release
      - name: Upload SBOM to release
        run: |
          gh release upload ${{ steps.tag.outputs.tag_name }} desktop-server.cyclonedx.json --clobber
        env:
          GITHUB_TOKEN: ${{ github.token }}

  # ------------------------------------------------------
  # â‘¡ Validate SBOM (CycloneDX)
  # ------------------------------------------------------
  validate:
    name: Validate SBOM
    runs-on: ubuntu-latest
    needs: generate
    permissions:
      contents: read
      actions: read

    steps:
      # âœ… å…ˆ checkout æ‰èƒ½è®“ gh release æ­£å¸¸é‹ä½œ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1ï¸âƒ£ ä¸‹è¼‰å‰›å‰›ç”¢çš„ SBOM
      - name: Download SBOM from release
        run: |
          gh release download ${{ github.ref_name }} \
            --pattern "desktop-server.cyclonedx.json" \
            --dir ./sbom
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # 2ï¸âƒ£ å®‰è£ CycloneDX CLI
      - name: Install CycloneDX CLI
        run: |
          curl -L -o cyclonedx \
            https://github.com/CycloneDX/cyclonedx-cli/releases/latest/download/cyclonedx-linux-x64
          chmod +x cyclonedx
          sudo mv cyclonedx /usr/local/bin/cyclonedx

      # 3ï¸âƒ£ é©—è­‰ SBOM æ ¼å¼
      - name: Validate SBOM
        run: |
          cyclonedx validate \
            --input-file ./sbom/desktop-server.cyclonedx.json \
            --input-format json \
            --fail-on-errors

      # 4ï¸âƒ£ é©—è­‰é€šéå¾Œä¸Šå‚³ validated SBOM
      - name: Upload validated SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-server-sbom-validated
          path: ./sbom/desktop-server.cyclonedx.json

  # ------------------------------------------------------
  # â‘¢ Trivy Scan
  # ------------------------------------------------------
  trivy-scan:
    name: Trivy Scan (CVE)
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: write
      actions: read

    steps:

      # âœ… å…ˆ checkout æ‰èƒ½è®“ gh release æ­£å¸¸é‹ä½œ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1ï¸âƒ£ ä¸‹è¼‰ä¸Šä¸€æ­¥é©—è­‰å¾Œçš„ SBOM
      - name: Download validated SBOM
        uses: actions/download-artifact@v4
        with:
          name: desktop-server-sbom-validated
          path: ./sbom

      # 2ï¸âƒ£ å®‰è£ Trivy
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      # 3ï¸âƒ£ æƒææ¼æ´
      - name: Run Trivy scan
        run: |
          echo "ğŸ” Running Trivy SBOM scan..."
          trivy sbom ./sbom/desktop-server.cyclonedx.json \
            -f json \
            -o trivy_report.json || true

      # 4ï¸âƒ£ ä¸Šå‚³å ±å‘Šèˆ‡ SBOM
      - name: Upload Trivy results to release
        run: |
          gh release upload ${{ github.ref_name }} trivy_report.json --clobber
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: |
            trivy_report.json
            ./sbom/desktop-server.cyclonedx.json

  # ------------------------------------------------------
  # â‘£ Syft Diff
  # ------------------------------------------------------
  syft-diff:
    name: Syft Diff (Compare Previous Release)
    runs-on: ubuntu-latest
    needs: trivy-scan
    permissions:
      contents: write

    steps:

      # âœ… å…ˆ checkout æ‰èƒ½è®“ gh release æ­£å¸¸é‹ä½œ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1ï¸âƒ£ ä¸‹è¼‰ç›®å‰ release çš„ SBOM
      - name: Download current release SBOM
        run: |
          gh release download ${{ github.ref_name }} \
            --pattern "desktop-server.cyclonedx.json" \
            --dir ./new
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # 2ï¸âƒ£ å–å¾—ä¸Šä¸€å€‹ tag
      - name: Find previous tag
        id: prev
        run: |
          git fetch --tags
          TAGS=($(git tag --sort=-creatordate | head -n 2))
          CURRENT=${TAGS[0]}
          PREVIOUS=${TAGS[1]:-none}
          echo "current_tag=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREVIOUS" >> $GITHUB_OUTPUT
          echo "ğŸ”– Current: $CURRENT"
          echo "â¬…ï¸ Previous: $PREVIOUS"

      - name: Skip if first release
        if: ${{ steps.prev.outputs.previous_tag == 'none' }}
        run: echo "No previous release found, skipping diff."

      # 3ï¸âƒ£ ä¸‹è¼‰ä¸Šä¸€ç‰ˆ release çš„ SBOM
      - name: Download previous release SBOM
        if: ${{ steps.prev.outputs.previous_tag != 'none' }}
        run: |
          gh release download ${{ steps.prev.outputs.previous_tag }} \
            --pattern "*.cyclonedx.json" \
            --dir ./old
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # 4ï¸âƒ£ å®‰è£ Syft
      # - name: Install Syft
      #   if: ${{ steps.prev.outputs.previous_tag != 'none' }}
      #   run: |
      #     curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin


      # 5ï¸âƒ£ æ¯”å° SBOM å·®ç•°
      - name: Compare SBOM JSON manually
        if: ${{ steps.prev.outputs.previous_tag != 'none' }}
        run: |
          echo "ğŸ” Comparing SBOMs..."
          jq --slurp '
            def toMap:
              map({ ( .name + ":" + ((.version // "unknown")|tostring) ): . }) | add;
            (.[0].components // [] | toMap) as $old |
            (.[1].components // [] | toMap) as $new |
            ($old | keys) as $old_keys |
            ($new | keys) as $new_keys |
            ( $new_keys - $old_keys ) as $added_keys |
            ( $old_keys - $new_keys ) as $removed_keys |
            ( ($old_keys + $new_keys) | unique ) as $all_keys |
            {
              added: ( $added_keys | map({ key: ., component: $new[.] }) ),
              removed: ( $removed_keys | map({ key: ., component: $old[.] }) ),
              changed: (
                $all_keys
                | map(
                    select( ($old[.] != null) and ($new[.] != null) and ($old[.] != $new[.]) )
                    | { key: ., old: $old[.], new: $new[.] }
                  )
              )
            }
          ' ./old/*.cyclonedx.json ./new/desktop-server.cyclonedx.json > sbom_diff.json

          echo "âœ… SBOM diff result:"
          cat sbom_diff.json


      # 6ï¸âƒ£ ä¸Šå‚³å·®ç•°çµæœå› release
      - name: Upload diff result
        if: ${{ steps.prev.outputs.previous_tag != 'none' }}
        run: |
          gh release upload ${{ github.ref_name }} sbom_diff.json --clobber
        env:
          GITHUB_TOKEN: ${{ github.token }}
